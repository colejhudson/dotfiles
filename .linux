#!/usr/bin/env fish

function link_to_home -a file
  if not test -f (pwd)/$file; and not test -f $HOME/$file
    ln -s (dirname (status --current-filename))/$file $HOME/$file
end

if not test $USER_IS_CONFIGURED
  if not test $CONFIGS_ARE_CONFIGURED
    link_to_home .vimrc
    link_to_home .tmux.conf
    link_to_home .ctags
    link_to_home .gitconfig
    link_to_home .gitignore
    link_to_home .lldbinit
    link_to_home .pypirc

    ln -s (dirname (status --current-filename))/.vimrc $HOME/.config/nvim/init.vim
    set -U CONFIGS_ARE_CONFIGURED true
  end

  if not test $VUNDLE_IS_CONFIGURED
    git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim
    vim +"so %" +"PluginInstall" +"qall" ~/.vimrc
    set -U VUNDLE_IS_CONFIGURED true
  end

  if not test $KEYBASE_IS_CONFIGURED
    # ensure gnupg uses curses
    sudo apt install pinentry-curses
    sudo update-alternatives --config pinentry

    # setup keybase
    curl --remote-name https://prerelease.keybase.io/keybase_amd64.deb
    sudo dpkg -i keybase_amd64.deb
    sudo apt-get install -f
    run_keybase

    # import public and private keys
    keybase pgp export | gpg --import
    set FINGERPRINT (gpg --list-keys cole@colejhudson.com | head -n 2 | tail -n 1 | tr -d ' ')
    keybase pgp pull-private $FINGERPRINT

    set -U KEYBASE_IS_CONFIGURED true
  end

  if not test $CRONTAB_IS_CONFIGURED
    crontab $DOT/crontab
  end

  set -U USER_IS_CONFIGURED true
end

if not test $SYSTEM_IS_CONFIGURED
  set -U SYSTEM_IS_CONFIGURED true
end

function reset_configuration
  rm ~/.vimrc
  rm ~/.tmux.conf
  rm ~/.ctags
  rm ~/.gitconfig
  rm ~/.gitignore
  rm ~/.lldbinit

  rm -rf ~/.vim/bundle/**

  set -e CONFIGURED
  set -e VUNDLE_IS_CONFIGURED
  set -e SYSTEM_IS_CONFIGURED
  set -e USER_IS_CONFIGURED
end
